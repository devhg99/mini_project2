{% extends "base.html" %}

{% block content %}
<div class="grid-container">
    <!-- ì™¼ìª½: ì‚¬ìš©ì ì…ë ¥ í¼ -->
    <div class="left-panel">
        <form method="POST" autocomplete="off">
            <h3>ğŸ“‹ ì—¬í–‰ ì¡°ê±´ ì…ë ¥</h3>
            <!-- ì—¬í–‰ ë‚ ì§œ ì„ íƒ -->
            <label>ì—¬í–‰ ë‚ ì§œ</label>
            <div class="row">
                <div class="half">
                    <label>ì‹œì‘ì¼</label>
                    <input type="date" name="start_date">
                </div>
                <div class="half">
                    <label>ì¢…ë£Œì¼</label>
                    <input type="date" name="end_date">
                </div>
            </div>

            <!-- ë™í–‰ ìœ í˜• ë° ì¸ì› ìˆ˜ -->
            <div class="row">
                <div class="half">
                    <label>ëˆ„êµ¬ì™€</label>
                    <select name="companions">
                        <option value="í˜¼ì">í˜¼ì</option>
                        <option value="ì¹œêµ¬">ì¹œêµ¬</option>
                        <option value="ì—°ì¸">ì—°ì¸</option>
                        <option value="ê°€ì¡±">ê°€ì¡±</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="half">
                    <label>ì´ ì¸ì›ìˆ˜</label>
                    <select name="people_count">
                        {% for i in range(1, 11) %}
                        <option value="{{ i }}">{{ i }}ëª…</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <!-- ì—¬í–‰ ì¥ì†Œ ì…ë ¥ -->
            <label>ì—¬í–‰ ì¥ì†Œ</label>
            <input type="text" name="location" placeholder="ì˜ˆ: ê²½ì£¼, ë¶€ì‚°">
            <!-- í…Œë§ˆ ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ -->
            <label>ì—¬í–‰ í…Œë§ˆ</label>
            <div class="theme-toggle-group">
                <input type="checkbox" id="theme1" name="theme" value="ë§›ì§‘">
                <label for="theme1">ë§›ì§‘</label>

                <input type="checkbox" id="theme2" name="theme" value="ì¹´í˜">
                <label for="theme2">ì¹´í˜</label>

                <input type="checkbox" id="theme3" name="theme" value="ìì—°ê²½ê´€">
                <label for="theme3">ìì—°ê²½ê´€</label>

                <input type="checkbox" id="theme4" name="theme" value="ì—­ì‚¬íƒë°©">
                <label for="theme4">ì—­ì‚¬íƒë°©</label>

                <input type="checkbox" id="theme5" name="theme" value="ì¶•ì œ/ì´ë²¤íŠ¸">
                <label for="theme5">ì¶•ì œ/ì´ë²¤íŠ¸</label>

                <input type="checkbox" id="theme6" name="theme" value="ì‡¼í•‘">
                <label for="theme6">ì‡¼í•‘</label>
            </div>

            <!-- í”„ë¡¬í”„íŠ¸ -->
            <label>ì¶”ê°€ ì¡°ê±´ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”</label>
            <textarea name="user_prompt" rows="4" placeholder="ì˜ˆ: ì²«ë‚ ì€ ë™ê¶ê³¼ì›”ì§€ë¥¼ ê¼­ ë„£ì–´ì£¼ì„¸ì„¸ìš”."></textarea>

            <button type="submit">ì¼ì • ìƒì„±</button>
        </form>
    </div>

    <!-- ì¤‘ì•™: GPT ìƒì„± ì¼ì • ì¶œë ¥ -->
    {% if result %}
    <div class="center-panel">
        <h3>ğŸ“… ì—¬í–‰ ì¼ì •</h3>
        <div class="itinerary-box">
            {{ result | safe }} <!-- HTMLë¡œ ë³€í™˜ëœ ì¼ì • ë§ˆí¬ë‹¤ìš´ ì¶œë ¥ -->
        </div>
    </div>
    {% endif %}

    <!-- ì˜¤ë¥¸ìª½: ì¹´ì¹´ì˜¤ ì§€ë„ -->
    <div class="right-panel">
        <h3>ğŸ—ºï¸ ì§€ë„</h3>
        <div id="map" style="width: 100%; height: 400px;"></div>
    </div>
</div>

<!-- ì¥ì†Œ ë§í¬ ìŠ¤íƒ€ì¼ -->
<style>
.place-link {
    color: #007bff;            /* íŒŒë€ìƒ‰ ë§í¬ */
    cursor: pointer;
    text-decoration: underline;
}
.place-link:hover {
    background-color: #eaf4ff; /* í˜¸ë²„ ì‹œ ë°°ê²½ */
}
</style>

<!-- Kakao Maps JavaScript SDK ë¡œë“œ -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>
<script>
// SDK ë¡œë“œ í›„ ì‹¤í–‰
kakao.maps.load(function () {
    // í˜„ì¬ ì—´ë¦° InfoWindow ì €ì¥ìš© ë³€ìˆ˜
    let currentInfoWindow = null;

    const mapContainer = document.getElementById('map');
    // ì´ˆê¸° ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ
    const center = new kakao.maps.LatLng({{ center_lat }}, {{ center_lng }});
    const map = new kakao.maps.Map(mapContainer, { center: center, level: 6 });

    // Flaskì—ì„œ ì „ë‹¬í•œ ë§ˆì»¤ ë°ì´í„°
    const markerData = {{ markers | tojson | safe }};
    const markerDict = {};

    // ê° ë§ˆì»¤ ìƒì„±
    markerData.forEach(m => {
        const pos = new kakao.maps.LatLng(m.lat, m.lng);
        const marker = new kakao.maps.Marker({ map, position: pos });
        // InfoWindow ë‚´ìš©: ë‚ ì§œ, ì‹œê°„, ì„¤ëª… í¬í•¨
        const info = new kakao.maps.InfoWindow({
            content: `
                <div style="padding:6px 10px; font-size:13px;">
                    <b>${m.day} ${m.time}</b><br>
                    ğŸ“ <b>${m.name}</b><br>
                    ğŸ“ ${m.desc}
                </div>`
        });
        // ë§ˆì»¤ í´ë¦­ ì‹œ InfoWindow ì—´ê¸°
        kakao.maps.event.addListener(marker, 'click', () =>{
            // ì´ì „ InfoWindow ë‹«ê¸°
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            // ìƒˆ InfoWindow ì—´ê¸° & ì €ì¥
            info.open(map, marker);
            currentInfoWindow = info;
        });

        markerDict[m.name] = { marker, info, pos };
    });
    // ì¼ì • ë‚´ ì¥ì†Œ í´ë¦­ ì‹œ â†’ ì§€ë„ ì´ë™ + InfoWindow í‘œì‹œ
    document.querySelectorAll('.place-link').forEach(el => {
        el.addEventListener('click', () => {
            const name = el.dataset.name;
            const data = markerDict[name];
            if (!data) return;

            // ì´ì „ InfoWindow ë‹«ê¸°
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            // ì§€ë„ ì„¼í„° ì´ë™ + ìƒˆ InfoWindow ì—´ê¸° & ì €ì¥
            map.setCenter(data.pos);
            data.info.open(map, data.marker);
            currentInfoWindow = data.info;
        });
    });
});
</script>

{% endblock %}